{% extends "layout.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å AI-—Å–µ—Ä–≤–∏—Å{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: {{ service.name }}</h1>
    <hr>
    <div class="row">
        <div class="col-md-8">
            <form action="{{ url_for('edit_service', service_id=service.id) }}" method="post" enctype="multipart/form-data" id="edit-service-form">
                <h5 class="mt-4">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞</label>
                        <input type="text" class="form-control" id="name" name="name" value="{{ service.name }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="provider" class="form-label">–ü—Ä–æ–≤–∞–π–¥–µ—Ä</label>
                        <input type="text" class="form-control" id="provider" name="provider" value="{{ service.provider }}">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="service_type" class="form-label">–¢–∏–ø —Å–µ—Ä–≤–∏—Å–∞</label>
                        <select class="form-select" id="service_type" name="service_type" required>
                            {% if schema and schema.service_types %}
                                {% for service_type in schema.service_types %}
                                    <option value="{{ service_type }}" {% if service.service_type == service_type %}selected{% endif %}>{{ service_type }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="AI Development Tool" {% if service.service_type == 'AI Development Tool' %}selected{% endif %}>AI Development Tool</option>
                                <option value="AI Writing Assistant" {% if service.service_type == 'AI Writing Assistant' %}selected{% endif %}>AI Writing Assistant</option>
                                <option value="AI Image Generator" {% if service.service_type == 'AI Image Generator' %}selected{% endif %}>AI Image Generator</option>
                                <option value="AI Video Generator" {% if service.service_type == 'AI Video Generator' %}selected{% endif %}>AI Video Generator</option>
                                <option value="Media Platform" {% if service.service_type == 'Media Platform' %}selected{% endif %}>Media Platform</option>
                                <option value="Professional Network" {% if service.service_type == 'Professional Network' %}selected{% endif %}>Professional Network</option>
                                <option value="Cloud Service" {% if service.service_type == 'Cloud Service' %}selected{% endif %}>Cloud Service</option>
                                <option value="Productivity Tool" {% if service.service_type == 'Productivity Tool' %}selected{% endif %}>Productivity Tool</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                        <select class="form-select" id="status" name="status">
                            <option value="active" {% if service.status == 'active' %}selected{% endif %}>–ê–∫—Ç–∏–≤–µ–Ω</option>
                            <option value="inactive" {% if service.status == 'inactive' %}selected{% endif %}>–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
                            <option value="trial" {% if service.status == 'trial' %}selected{% endif %}>–ü—Ä–æ–±–Ω–∞—è –≤–µ—Ä—Å–∏—è</option>
                            <option value="expired" {% if service.status == 'expired' %}selected{% endif %}>–ò—Å—Ç—ë–∫</option>
                            <option value="cancelled" {% if service.status == 'cancelled' %}selected{% endif %}>–û—Ç–º–µ–Ω—ë–Ω</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="login_url" class="form-label">URL –¥–ª—è –≤—Ö–æ–¥–∞</label>
                    <input type="url" class="form-control" id="login_url" name="login_url" value="{{ service.login_url }}">
                </div>
                <div class="mb-3">
                    <label for="preferred_oauth_method" class="form-label">–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞</label>
                    <select class="form-select" id="preferred_oauth_method" name="preferred_oauth_method">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞...</option>
                    </select>
                    <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ —Å–µ—Ä–≤–∏—Å–∞</div>                </div>

                <div class="accordion" id="credentials-accordion">
  <div class="accordion-item">
    <h2 class="accordion-header" id="credentials-heading">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#credentials-collapse" aria-expanded="false" aria-controls="credentials-collapse">
        <i class="bi bi-key me-2"></i>–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      </button>
    </h2>
    <div id="credentials-collapse" class="accordion-collapse collapse" aria-labelledby="credentials-heading" data-bs-parent="#credentials-accordion">
      <div class="accordion-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="username" class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/Email</label>
                        <input type="text" class="form-control" id="username" name="username" value="{{ service.credentials.username }}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="password" class="form-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" id="password" name="password" aria-describedby="passwordHelp">
                        <div id="passwordHelp" class="form-text">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å.</div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="additional_info" class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –≤—Ö–æ–¥–∞</label>
                    <textarea class="form-control" id="additional_info" name="additional_info" rows="2">{{ service.credentials.additional_info }}</textarea>
                </div>

                </div>
      </div>
    </div>
  </div>
</div>

<h5 class="mt-4">–ü–æ–¥–ø–∏—Å–∫–∞ –∏ –æ–ø–ª–∞—Ç–∞</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="plan_name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞</label>
                        <input type="text" class="form-control" id="plan_name" name="plan_name" value="{{ service.subscription.plan_name }}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="cost_monthly" class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –≤ –º–µ—Å—è—Ü</label>
                        <input type="number" step="0.01" class="form-control" id="cost_monthly" name="cost_monthly" value="{{ service.subscription.cost_monthly }}">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="currency" class="form-label">–í–∞–ª—é—Ç–∞</label>
                        <select class="form-select" id="currency" name="currency">
                            <option value="USD" {% if service.subscription.currency == 'USD' %}selected{% endif %}>USD</option>
                            <option value="EUR" {% if service.subscription.currency == 'EUR' %}selected{% endif %}>EUR</option>
                            <option value="RUB" {% if service.subscription.currency == 'RUB' %}selected{% endif %}>RUB</option>
                            <option value="GBP" {% if service.subscription.currency == 'GBP' %}selected{% endif %}>GBP</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="billing_cycle" class="form-label">–ü–µ—Ä–∏–æ–¥ –æ–ø–ª–∞—Ç—ã</label>
                        <select class="form-select" id="billing_cycle" name="billing_cycle">
                            <option value="monthly" {% if service.subscription.billing_cycle == 'monthly' %}selected{% endif %}>–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
                            <option value="quarterly" {% if service.subscription.billing_cycle == 'quarterly' %}selected{% endif %}>–ï–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ</option>
                            <option value="yearly" {% if service.subscription.billing_cycle == 'yearly' %}selected{% endif %}>–ï–∂–µ–≥–æ–¥–Ω–æ</option>
                            <option value="weekly" {% if service.subscription.billing_cycle == 'weekly' %}selected{% endif %}>–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="next_payment_date" class="form-label">–°–ª–µ–¥—É—é—â–∏–π –ø–ª–∞—Ç—ë–∂</label>
                        <input type="date" class="form-control" id="next_payment_date" name="next_payment_date" value="{{ service.subscription.next_payment_date }}">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="payment_method" class="form-label">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
                        <input type="text" class="form-control" id="payment_method" name="payment_method" value="{{ service.subscription.payment_method }}">
                    </div>
                    <div class="col-md-6 mb-3 d-flex align-items-end">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="auto_renewal" name="auto_renewal" {% if service.subscription.auto_renewal %}checked{% endif %}>
                            <label class="form-check-label" for="auto_renewal">
                                –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="subscription_notes" class="form-label">–ó–∞–º–µ—Ç–∫–∏ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ</label>
                    <textarea class="form-control" id="subscription_notes" name="subscription_notes" rows="2">{{ service.subscription.notes }}</textarea>
                </div>

                <h5 class="mt-4">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="dashboard_url" class="form-label">URL –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</label>
                        <input type="url" class="form-control" id="dashboard_url" name="dashboard_url" value="{{ service.personal_cabinet.dashboard_url }}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="account_email" class="form-label">Email –∞–∫–∫–∞—É–Ω—Ç–∞</label>
                        <input type="email" class="form-control" id="account_email" name="account_email" value="{{ service.personal_cabinet.account_email }}">
                    </div>
                </div>

                <h5 class="mt-4">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h5>
                 <div class="mb-3">
                    <label for="features" class="form-label">–ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                    <textarea class="form-control" id="features" name="features" rows="3">{{ service.features | join(', ') }}</textarea>
                    <div class="form-text">–í–≤–µ–¥–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</div>
                </div>

                <h5 class="mt-4">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h5>
                <div class="row align-items-center">
                    <div class="col-md-6 mb-3">
                        <label for="icon_filename" class="form-label">–ò–∫–æ–Ω–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ (–∑–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â—É—é)</label>
                        <input class="form-control" type="file" id="icon_filename" name="icon_filename" accept="image/*">
                        {% if service.icon_filename %}
                        <div class="mt-2">
                            <small>–¢–µ–∫—É—â–∞—è:</small>
                            <img src="{{ url_for('uploaded_file', filename=service.icon_filename) }}" alt="icon" class="img-thumbnail" style="width: 40px; height: 40px; object-fit: contain; margin-left: 10px;">
                    </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="gradient_color" class="form-label">–¶–≤–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏</label>
                        <div class="input-group">
                            <input type="color" class="form-control form-control-color" id="gradient_color" name="gradient_color" 
                                   value="{{ service.gradient_color or '#667eea' }}" 
                                   title="–í—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç">
                        </div>
                    </div>
                </div>

                <script>
                function generateGradient(baseColor) {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º hex –≤ RGB
                    const hexToRgb = (hex) => {
                        const bigint = parseInt(hex.slice(1), 16);
                        const r = (bigint >> 16) & 255;
                        const g = (bigint >> 8) & 255;
                        const b = bigint & 255;
                        return [r, g, b];
                    };

                    // –°–æ–∑–¥–∞–µ–º –±–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π –∏–ª–∏ —Å–≤–µ—Ç–ª—ã–π –æ—Ç—Ç–µ–Ω–æ–∫
                    const adjustColor = (rgb, factor) => {
                        return rgb.map(channel => 
                            Math.min(255, Math.max(0, Math.round(channel * factor)))
                        );
                    };

                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º RGB –æ–±—Ä–∞—Ç–Ω–æ –≤ hex
                    const rgbToHex = (rgb) => {
                        return '#' + rgb.map(x => {
                            const hex = x.toString(16);
                            return hex.length === 1 ? '0' + hex : hex;
                        }).join('');
                    };

                    // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç
                    const rgb = hexToRgb(baseColor);
                    const darkerRgb = adjustColor(rgb, 0.7);  // –¢–µ–º–Ω–µ–µ
                    const lighterRgb = adjustColor(rgb, 1.3); // –°–≤–µ—Ç–ª–µ–µ

                    return {
                        color1: baseColor,
                        color2: rgbToHex(darkerRgb)
                    };
                }
                </script>

                <h5 class="mt-4">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                <div class="mb-3">
                    <label for="notes" class="form-label">–ó–∞–º–µ—Ç–∫–∏</label>
                    <textarea class="form-control" id="notes" name="notes" rows="3">{{ service.notes }}</textarea>
                </div>
                
                <button type="submit" class="btn btn-primary mt-3">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                <a href="{{ url_for('index') }}" class="btn btn-secondary mt-3">–û—Ç–º–µ–Ω–∞</a>
            </form>
        </div>
        <div class="col-md-4">
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–∏—Å–µ</h5>
                </div>
                <div class="card-body">
                    {% if service.created_at %}
                    <p><strong>–°–æ–∑–¥–∞–Ω:</strong> {{ service.created_at | format_datetime }}</p>
                    {% endif %}
                    {% if service.updated_at %}
                    <p><strong>–û–±–Ω–æ–≤–ª—ë–Ω:</strong> {{ service.updated_at | format_datetime }}</p>
                    {% endif %}
                    
                    <hr>
                    
                    <div class="alert alert-info" role="alert">
                        <strong>üí° –°–æ–≤–µ—Ç:</strong> –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤
                    </div>
                    
                    {% if service.subscription.cost_monthly %}
                    <div class="alert alert-success" role="alert">
                        <strong>üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> 
                        ~{{ (service.subscription.cost_monthly * 12) | round(2) }} {{ service.subscription.currency }} –≤ –≥–æ–¥
                            </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è OAuth –º–µ—Ç–æ–¥–æ–≤
document.addEventListener('DOMContentLoaded', updateOAuthMethods);
</script>{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –í–∞–ª–∏–¥–∞—Ü–∏—è URL
    const urlFields = ['login_url', 'dashboard_url'];
    urlFields.forEach(fieldName => {
        const field = document.getElementById(fieldName);
        if (field) {
            field.addEventListener('blur', function() {
                if (this.value && !this.value.startsWith('http')) {
                    this.value = 'https://' + this.value;
                }
            });
        }
    });

    // –ü–æ–¥—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ –≥–æ–¥
    const costField = document.getElementById('cost_monthly');
    const cycleField = document.getElementById('billing_cycle');
    
    function updateYearlyCost() {
        const monthlyCost = parseFloat(costField.value) || 0;
        const cycle = cycleField.value;
        let yearlyCost = 0;
        
        switch(cycle) {
            case 'weekly': yearlyCost = monthlyCost * 52; break;
            case 'monthly': yearlyCost = monthlyCost * 12; break;
            case 'quarterly': yearlyCost = monthlyCost * 4; break;
            case 'yearly': yearlyCost = monthlyCost; break;
        }
        
        if (yearlyCost > 0) {
            costField.title = `–ü—Ä–∏–º–µ—Ä–Ω–æ ${yearlyCost.toFixed(2)} –≤ –≥–æ–¥`;
        }
    }
    
    if (costField && cycleField) {
        costField.addEventListener('input', updateYearlyCost);
        cycleField.addEventListener('change', updateYearlyCost);
        updateYearlyCost(); // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç
    }
});
</script>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è OAuth –º–µ—Ç–æ–¥–æ–≤
function updateOAuthMethods() {
    const serviceName = document.getElementById('name').value;
    const select = document.getElementById('preferred_oauth_method');
    const currentValue = '{{ service.preferred_oauth_method if service.preferred_oauth_method else "" }}';
    
    // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –æ–ø—Ü–∏–∏
    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞...</option>';
    
    if (!serviceName) return;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ OAuth –º–µ—Ç–æ–¥—ã
    const oauthMethods = getOAuthMethods(serviceName);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏
    Object.entries(oauthMethods).forEach(([key, oauth]) => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = `${oauth.icon} ${oauth.name}`;
        option.selected = key === currentValue;
        select.appendChild(option);
    });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è OAuth –º–µ—Ç–æ–¥–æ–≤ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
function getOAuthMethods(serviceName) {
    const methods = {};
    
    // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    const lowerName = serviceName.toLowerCase();
    if (lowerName.includes('cursor')) {
        methods.cursor = { name: 'Cursor Account', icon: '‚ö°' };
    } else if (lowerName.includes('chatgpt') || lowerName.includes('openai')) {
        methods.openai = { name: 'OpenAI Account', icon: 'ü§ñ' };
    } else if (lowerName.includes('medium')) {
        methods.medium = { name: 'Medium Account', icon: 'üìù' };
    } else if (lowerName.includes('notion')) {
        methods.notion = { name: 'Notion Account', icon: 'üìÑ' };
    } else if (lowerName.includes('figma')) {
        methods.figma = { name: 'Figma Account', icon: 'üé®' };
    }
    
    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    methods.google = { name: 'Google', icon: 'üîê' };
    methods.apple = { name: 'Apple ID', icon: 'üçé' };
    methods.github = { name: 'GitHub', icon: 'üêô' };
    methods.microsoft = { name: 'Microsoft', icon: 'ü™ü' };
    
    return methods;
}

// –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–æ–¥—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–º–µ–Ω–∏ —Å–µ—Ä–≤–∏—Å–∞
document.getElementById('name').addEventListener('input', updateOAuthMethods);
document.getElementById('name').addEventListener('change', updateOAuthMethods);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', updateOAuthMethods);
</script>
{% endblock %}