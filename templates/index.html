{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <!-- Блок для вывода flash-сообщений -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>Список AI-сервисов</h1>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('yubikey_setup') }}" class="btn btn-outline-warning">
                <i class="bi bi-shield-lock me-1"></i> Настроить YubiKey
            </a>
        <a href="{{ url_for('add_service') }}" class="btn btn-primary">Добавить AI-сервис</a>
        </div>
    </div>

    {% if not active_data_file and not servers %}
    <div class="card text-center shadow-sm">
        <div class="card-body">
            <p class="card-text pt-2">
                Вы можете начать с добавления вашего первого AI-сервиса или импортировать существующие данные.
            </p>
            <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                 <a href="{{ url_for('add_service') }}" class="btn btn-primary btn-lg px-4 gap-3">
                    <i class="bi bi-plus-circle"></i> Добавить первый AI-сервис
                </a>
                <a href="{{ url_for('settings_page') }}" class="btn btn-outline-secondary btn-lg px-4">
                    <i class="bi bi-upload"></i> Импортировать данные
                </a>
            </div>
        </div>
        <div class="card-footer text-muted">
            Все данные будут сохранены в зашифрованный файл.
        </div>
    </div>
    {% elif servers %}
    <div class="position-relative carousel-wrapper">
      <button class="carousel-arrow carousel-arrow-left" onclick="carouselScroll('left')" aria-label="Влево">
        <i class="bi bi-chevron-left"></i>
      </button>
      <div class="card-carousel-row" id="card-carousel-row">
        {% for server in servers %}
          <div class="card card-carousel-card" id="carousel-card-{{ loop.index0 }}">
            {% include 'card_content.html' %}
            <div class="card-stack-actions">
                    <div class="d-flex justify-content-between mt-3">
                        <a href="{{ url_for('edit_service', service_id=server.id) }}" class="btn btn-sm btn-outline-secondary me-2">
                            <i class="bi bi-pencil"></i> Редактировать
                    </a>
                        <form action="{{ url_for('delete_service', service_id=server.id) }}" method="post" onsubmit="return confirm('Вы уверены, что хотите удалить этот AI-сервис?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-trash"></i> Удалить
                            </button>
                    </form>
                    </div>
                </div>
            </div>
        {% endfor %}
        </div>
      <button class="carousel-arrow carousel-arrow-right" onclick="carouselScroll('right')" aria-label="Вправо">
        <i class="bi bi-chevron-right"></i>
      </button>
      <div class="carousel-indicators" id="carousel-indicators">
        {% for server in servers %}
          <span class="carousel-indicator-dot{% if loop.index0 == 0 %} active{% endif %}" data-idx="{{ loop.index0 }}" data-dot-color="{{ server.gradient_color or '#667eea' }}"></span>
        {% endfor %}
      </div>
    </div>
    {% else %}
    <div class="alert alert-info text-center" role="alert">
        AI-сервисов пока нет. <a href="{{ url_for('add_service') }}" class="alert-link">Добавьте первый</a> или <a href="{{ url_for('settings_page') }}" class="alert-link">импортируйте данные</a>.
    </div>
    {% endif %}
</div>

<!-- Modal для отображения информации IP -->
<div class="modal fade" id="ipModal" tabindex="-1" aria-labelledby="ipModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
                <h5 class="modal-title" id="ipModalLabel">Информация об IP-адресе</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
                <pre id="ipInfo">Загрузка...</pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  let activeCardIndex = 0;
  let ignoreScroll = false;

  function setActiveCard(index) {
    document.querySelectorAll('.card-carousel-card').forEach((card, idx) => {
      if (idx === index) {
        card.classList.add('active');
      } else {
        card.classList.remove('active');
      }
    });
    updateIndicators();
  }
  function updateIndicators() {
    const dots = document.querySelectorAll('.carousel-indicator-dot');
    dots.forEach((dot, idx) => {
      dot.classList.toggle('active', idx === activeCardIndex);
    });
  }
  setActiveCard(activeCardIndex);
  const carousel = document.getElementById('card-carousel-row');
  const indicators = document.querySelectorAll('.carousel-indicator-dot');
  if (carousel) {
    carousel.addEventListener('scroll', function() {
      if (ignoreScroll) return;
      const cards = Array.from(document.querySelectorAll('.card-carousel-card'));
      const carouselRect = carousel.getBoundingClientRect();
      let minDist = Infinity, activeIdx = 0;
      cards.forEach((card, idx) => {
        const rect = card.getBoundingClientRect();
        const cardCenter = rect.left + rect.width / 2;
        const carouselCenter = carouselRect.left + carouselRect.width / 2;
        const dist = Math.abs(cardCenter - carouselCenter);
        if (dist < minDist) {
          minDist = dist;
          activeIdx = idx;
        }
      });
      // Если прокрутили до самого конца вправо — явно делаем активной последнюю карточку
      if (Math.abs(carousel.scrollLeft + carousel.offsetWidth - carousel.scrollWidth) < 2) {
        activeIdx = cards.length - 1;
      }
      // Если прокрутили до самого начала — явно делаем активной первую карточку
      if (carousel.scrollLeft === 0) {
        activeIdx = 0;
      }
      setActiveCard(activeIdx);
      activeCardIndex = activeIdx;
    });
    // wheel scroll горизонтально
    carousel.addEventListener('wheel', function(e) {
      if (e.deltaY !== 0) {
        e.preventDefault();
        carousel.scrollBy({ left: e.deltaY, behavior: 'smooth' });
      }
    }, { passive: false });
  }
  // Индикаторы кликабельны
  indicators.forEach((dot, idx) => {
    dot.addEventListener('click', () => {
      activeCardIndex = idx;
      setActiveCard(activeCardIndex);
      ignoreScroll = true;
      document.querySelectorAll('.card-carousel-card')[activeCardIndex].scrollIntoView({ behavior: 'smooth', inline: 'center', 'block': 'nearest' });
      setTimeout(() => { ignoreScroll = false; }, 500);
      updateIndicators();
    });
  });
  window.carouselScroll = function(direction) {
    const cards = document.querySelectorAll('.card-carousel-card');
    if (direction === 'left' && activeCardIndex > 0) {
      activeCardIndex--;
    } else if (direction === 'right' && activeCardIndex < cards.length - 1) {
      activeCardIndex++;
    }
    setActiveCard(activeCardIndex);
    ignoreScroll = true;
    cards[activeCardIndex].scrollIntoView({ behavior: 'smooth', 'inline': 'center', 'block': 'nearest' });
    setTimeout(() => { ignoreScroll = false; }, 500);
  };
  document.querySelectorAll('.carousel-indicator-dot').forEach(dot => {
    dot.style.background = dot.getAttribute('data-dot-color');
  });
  // Перемещение по стрелкам клавиатуры
  document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
      window.carouselScroll('left');
    } else if (e.key === 'ArrowRight') {
      window.carouselScroll('right');
    }
  });
});
</script>
{% endblock %}