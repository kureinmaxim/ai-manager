# 📋 Алгоритм работы приложения AI Manager

## 🎯 Общее описание

AI Manager - это безопасный менеджер для управления учетными записями AI сервисов с шифрованием данных и двухфакторной аутентификацией через YubiKey.

---

## 🚀 1. Запуск приложения

### Точки входа

```
┌─────────────────────────────────────────┐
│         Запуск приложения               │
├─────────────────────────────────────────┤
│  Вариант 1: python run_app.py          │
│  → GUI окно (PyWebView)                 │
│                                         │
│  Вариант 2: python app.py              │
│  → Веб-интерфейс в браузере            │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  Flask сервер запускается на:           │
│  http://127.0.0.1:5050                  │
└─────────────────────────────────────────┘
```

### Инициализация при старте

1. **Загрузка переменных окружения** (`.env`)
   - `SECRET_KEY` - ключ шифрования (Fernet, 44 символа)
   - `YUBIKEY_STATIC_PASSWORDS` - пароли для офлайн-режима
   - `DEV_PIN` - PIN-код разработчика

2. **Определение директории данных**
   - **Разработка:** текущая папка проекта
   - **Windows (установлено):** `%APPDATA%\AllManagerC\`
   - **macOS (установлено):** `~/Library/Application Support/AllManagerC/`
   - **Linux (установлено):** `~/.local/share/AllManagerC/`

3. **Загрузка конфигурации** (`config.json`)
   - Версия приложения (5.6.0)
   - Активный файл данных (`.enc`)
   - Настройки безопасности

4. **Инициализация YubiKey аутентификации** (`yubikey_config.json`)
   - Загрузка ключей YubiKey (Client ID + Secret Key)
   - Список разрешенных Public ID
   - Статус (включена/выключена)

---

## 🔐 2. Система аутентификации

### Схема работы аутентификации

```
┌─────────────────────────────────────────┐
│     Пользователь открывает приложение   │
└──────────────┬──────────────────────────┘
               ↓
       ┌───────────────┐
       │ Есть сессия?  │
       └───────┬───────┘
           Да ↓     ↓ Нет
    ┌───────────┐   └─────────────────┐
    │  Главная  │                     ↓
    │  страница │          ┌──────────────────┐
    └───────────┘          │ /yubikey/login   │
                           └──────────────────┘
                                    ↓
                   ┌────────────────────────────┐
                   │  Выбор метода входа        │
                   ├────────────────────────────┤
                   │  1. YubiKey OTP (онлайн)   │
                   │  2. Статический пароль     │
                   │  3. Secret PIN             │
                   └────────────────────────────┘
```

### 2.1 YubiKey OTP (онлайн-режим)

**Шаг 1: Проверка интернет-соединения**
```python
check_internet_connection() - Проверяет доступность:
├─ Прямой TCP к 1.1.1.1:443 (Cloudflare DNS)
├─ Прямой TCP к 8.8.8.8:443 (Google DNS)
├─ Прямой TCP к 9.9.9.9:443 (Quad9 DNS)
└─ DNS + TCP к api.yubico.com:443
```

**Шаг 2: Ввод OTP и проверка**
```
Пользователь касается YubiKey
    ↓
Генерируется 44-символьный OTP
Пример: ccccccbtclidefghijklnrtctvdlgknihlgrcddefghijklnrtu
    ↓
Парсинг OTP:
├─ Public ID (12 символов): ccccccbtclie
└─ Encrypted part (32 символа): defgh...rtu
    ↓
Проверка Public ID в списке разрешенных
    ↓
Отправка на YubiCloud API:
├─ client_id: 12345
├─ secret_key: abcd1234==
└─ otp: полный OTP
    ↓
YubiCloud проверяет:
├─ Подпись запроса (HMAC)
├─ Валидность OTP
├─ Счетчик использования
└─ Временную метку
    ↓
Результат: OK/BAD_OTP/REPLAYED_OTP/ERROR
    ↓
При OK: session['yubikey_authenticated'] = True
```

### 2.2 Статический пароль (офлайн-режим)

```
Пользователь вводит пароль
    ↓
Проверка в списке: YUBIKEY_STATIC_PASSWORDS
    ↓
Если найден: session['yubikey_authenticated'] = True
```

Пример настройки в `.env`:
```env
YUBIKEY_STATIC_PASSWORDS=demo123,test123,admin123
```

### 2.3 Secret PIN

```
Пользователь вводит PIN-код
    ↓
Проверка источников (по приоритету):
├─ 1. Переменная окружения: DEV_PIN
├─ 2. Переменная окружения: DEVELOPER_PIN
└─ 3. config.json → security.secret_pin.current_pin
    ↓
Антибрут защита:
├─ Попытка 1: OK
├─ Попытка 2: OK
├─ Попытка 3: OK
└─ Попытка 4+: Блокировка на 30 секунд
    ↓
При успехе: session['yubikey_authenticated'] = True
```

### 2.4 Защищенные маршруты

Все страницы защищены **кроме**:
- `/yubikey/login` - страница входа
- `/yubikey/setup` - настройка YubiKey
- `/help` - справка
- `/about` - о программе
- `/static/*` - статические файлы

---

## 🔒 3. Система шифрования данных

### Архитектура шифрования

```
┌─────────────────────────────────────────────────┐
│           Ключ шифрования (SECRET_KEY)          │
│  ┌───────────────────────────────────────────┐  │
│  │ Fernet (AES-128 CBC + HMAC-SHA256)        │  │
│  │ Длина: 44 символа (base64)               │  │
│  │ Пример: gAAAAABh... (автогенерация)       │  │
│  └───────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│        Зашифрованный файл данных (.enc)         │
│  ┌───────────────────────────────────────────┐  │
│  │ Путь: data/ai_services_*.enc              │  │
│  │ Формат: двоичный (Fernet-encrypted JSON)  │  │
│  └───────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
```

### 3.1 Поля, которые шифруются

**Учетные данные сервиса:**
- `credentials.username` - имя пользователя
- `credentials.password` - пароль
- `credentials.additional_info` - дополнительная информация

**Учетные данные панели управления:**
- `panel_credentials.user` - логин панели
- `panel_credentials.password` - пароль панели

**Учетные данные хостинга:**
- `hoster_credentials.user` - логин хостера
- `hoster_credentials.password` - пароль хостера

**SSH доступ:**
- `ssh_credentials.password` - SSH пароль
- `ssh_credentials.root_password` - root пароль

**Личный кабинет:**
- `personal_cabinet.account_email` - email аккаунта

### 3.2 Процесс шифрования/дешифрования

**Сохранение данных (шифрование):**
```
1. Данные в памяти (Python объекты)
        ↓
2. Глубокое копирование (без временных полей)
        ↓
3. Сериализация в JSON (строка)
        ↓
4. Преобразование в байты (UTF-8)
        ↓
5. Шифрование через Fernet
   fernet.encrypt(json_bytes)
        ↓
6. Запись в файл .enc (бинарный режим)
```

**Загрузка данных (дешифрование):**
```
1. Чтение файла .enc (бинарный режим)
        ↓
2. Дешифрование через Fernet
   fernet.decrypt(encrypted_data)
        ↓
3. Преобразование в строку (UTF-8)
        ↓
4. Парсинг JSON в Python объекты
        ↓
5. Расшифровка чувствительных полей
   (password → password_decrypted)
        ↓
6. Данные в памяти (готовы к использованию)
```

### 3.3 Смена ключа шифрования

```
Пользователь: Настройки → Сменить ключ шифрования
        ↓
┌────────────────────────────────────────┐
│  1. Валидация нового ключа (Fernet)    │
└────────────────────────────────────────┘
        ↓
┌────────────────────────────────────────┐
│  2. Создание резервной копии           │
│     backup_before_key_change_*.enc     │
└────────────────────────────────────────┘
        ↓
┌────────────────────────────────────────┐
│  3. Загрузка всех данных СТАРЫМ ключом │
└────────────────────────────────────────┘
        ↓
┌────────────────────────────────────────┐
│  4. Обновление SECRET_KEY в памяти     │
└────────────────────────────────────────┘
        ↓
┌────────────────────────────────────────┐
│  5. Запись .env файла с НОВЫМ ключом   │
└────────────────────────────────────────┘
        ↓
┌────────────────────────────────────────┐
│  6. Сохранение данных НОВЫМ ключом     │
│     ai_services_reencrypted_*.enc      │
└────────────────────────────────────────┘
        ↓
┌────────────────────────────────────────┐
│  7. Обновление active_data_file        │
│     в config.json                      │
└────────────────────────────────────────┘
        ↓
    Успех ✅
    (При ошибке: откат из резервной копии)
```

---

## 📊 4. Управление AI сервисами

### 4.1 Структура данных сервиса

Каждый сервис хранится как JSON-объект:

```json
{
  "id": 1,
  "name": "OpenAI ChatGPT",
  "service_type": "AI Development Tool",
  "provider": "OpenAI",
  "login_url": "https://chat.openai.com",
  "preferred_oauth_method": "Google OAuth",

  "credentials": {
    "username": "gAAAAA...(зашифровано)",
    "password": "gAAAAA...(зашифровано)",
    "additional_info": "gAAAAA...(зашифровано)"
  },

  "subscription": {
    "plan_name": "ChatGPT Plus",
    "cost_monthly": 20.0,
    "currency": "USD",
    "billing_cycle": "monthly",
    "next_payment_date": "2025-12-06",
    "auto_renewal": true,
    "payment_method": "Credit Card",
    "notes": "Персональная подписка"
  },

  "personal_cabinet": {
    "dashboard_url": "https://platform.openai.com/account",
    "account_email": "gAAAAA...(зашифровано)"
  },

  "features": [
    "GPT-4 доступ",
    "Приоритетная обработка",
    "Расширенные модели"
  ],

  "status": "active",
  "gradient_color": "#667eea",
  "icon_filename": "1_icon.png",
  "created_at": "2025-01-15T10:30:00",
  "updated_at": "2025-11-06T14:22:00"
}
```

### 4.2 Добавление нового сервиса

```
Главная страница → Кнопка "Добавить сервис"
        ↓
┌─────────────────────────────────────────┐
│  Форма добавления сервиса               │
│  (/add)                                 │
├─────────────────────────────────────────┤
│  Обязательные поля:                     │
│  • Название                             │
│  • Тип сервиса                          │
│  • Провайдер                            │
│                                         │
│  Опциональные поля:                     │
│  • URL входа                            │
│  • OAuth метод                          │
│  • Логин                                │
│  • Пароль                               │
│  • Email                                │
│  • План подписки                        │
│  • Стоимость                            │
│  • Следующий платеж                     │
│  • Иконка (загрузка файла)              │
│  • Цвет градиента                       │
└─────────────────────────────────────────┘
        ↓
    Нажатие "Сохранить"
        ↓
┌─────────────────────────────────────────┐
│  Обработка на сервере (POST /add)       │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│  1. Загрузка существующих сервисов      │
│     load_ai_services()                  │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│  2. Генерация нового ID                 │
│     id = max(existing_ids) + 1          │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│  3. Шифрование чувствительных данных    │
│     • password → encrypt_data()         │
│     • email → encrypt_data()            │
│     • additional_info → encrypt_data()  │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│  4. Обработка загруженной иконки        │
│     • Безопасное имя файла              │
│     • Сохранение в uploads/             │
│     • Генерация thumbnail               │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│  5. Генерация цветового градиента       │
│     • Основной цвет → gradient_color    │
│     • Вычисление lighter/darker         │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│  6. Добавление временных меток          │
│     • created_at: ISO 8601 timestamp    │
│     • updated_at: ISO 8601 timestamp    │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│  7. Добавление в список сервисов        │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│  8. Сохранение всех данных              │
│     save_ai_services() → encrypt → .enc │
└─────────────────────────────────────────┘
        ↓
    Редирект на главную (/)
    + Flash сообщение: "Сервис добавлен"
```

### 4.3 Просмотр списка сервисов

```
Пользователь открывает главную страницу (/)
        ↓
┌─────────────────────────────────────────┐
│  Загрузка данных                        │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│  1. Чтение .enc файла                   │
│     путь из config.json                 │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│  2. Дешифрование файла (Fernet)         │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│  3. Парсинг JSON                        │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│  4. Для каждого сервиса:                │
│     • Расшифровка паролей               │
│     • Расшифровка email                 │
│     • Добавление _decrypted полей       │
│     • Форматирование дат                │
│     • Анализ статуса платежей           │
│     • Подсчет дней до платежа           │
│     • Определение geolocation хостинга  │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│  5. Отображение карточек сервисов       │
│     (index.html)                        │
├─────────────────────────────────────────┤
│  Каждая карточка показывает:            │
│  • Иконка + название                    │
│  • Статус (active/trial/expired)        │
│  • Стоимость подписки                   │
│  • Дата следующего платежа              │
│  • Кнопки: Просмотр / Редактировать     │
└─────────────────────────────────────────┘
```

### 4.4 Редактирование сервиса

```
Карточка сервиса → Кнопка "Редактировать"
        ↓
┌─────────────────────────────────────────┐
│  GET /edit/<service_id>                 │
├─────────────────────────────────────────┤
│  • Загрузка данных сервиса              │
│  • Расшифровка всех полей               │
│  • Заполнение формы                     │
└─────────────────────────────────────────┘
        ↓
    Пользователь изменяет данные
        ↓
    Нажатие "Сохранить"
        ↓
┌─────────────────────────────────────────┐
│  POST /edit/<service_id>                │
├─────────────────────────────────────────┤
│  1. Загрузка всех сервисов              │
│  2. Поиск сервиса по ID                 │
│  3. Обновление полей из формы           │
│  4. Шифрование новых паролей            │
│  5. Обновление updated_at               │
│  6. Сохранение в .enc файл              │
└─────────────────────────────────────────┘
        ↓
    Редирект на главную
```

### 4.5 Удаление сервиса

```
Карточка сервиса → Кнопка "Удалить"
        ↓
    JavaScript подтверждение:
    "Вы уверены, что хотите удалить сервис?"
        ↓
    Пользователь: Да
        ↓
┌─────────────────────────────────────────┐
│  POST /delete/<service_id>              │
├─────────────────────────────────────────┤
│  1. Загрузка всех сервисов              │
│  2. Фильтрация: удаление по ID          │
│  3. Удаление иконки из uploads/         │
│  4. Удаление чеков из receipts/         │
│  5. Сохранение обновленного списка      │
└─────────────────────────────────────────┘
        ↓
    Редирект на главную
    + Flash: "Сервис удален"
```

---

## 💾 5. Импорт и экспорт данных

### 5.1 Экспорт данных

**Вариант 1: Экспорт только данных**
```
Настройки → "Экспорт данных"
        ↓
GET /data/export
        ↓
Скачивание файла:
└─ ai_services_YYYYMMDD_HHMMSS.enc
```

**Вариант 2: Экспорт ключа шифрования**
```
Настройки → "Экспорт ключа"
        ↓
GET /data/export_key
        ↓
Скачивание файла:
└─ encryption_key.env
   (содержит SECRET_KEY=...)
```

**Вариант 3: Полный экспорт (ZIP-архив)**
```
Настройки → "Экспорт всего"
        ↓
GET /data/export_package
        ↓
Создание ZIP архива:
├─ data.enc (зашифрованные данные)
├─ key.env (ключ шифрования)
└─ receipts/ (все чеки оплаты)
        ↓
Скачивание:
└─ ai_services_package_YYYYMMDD_HHMMSS.zip
```

### 5.2 Импорт данных

**Вариант 1: Импорт с текущим ключом**
```
Настройки → "Импорт данных"
        ↓
Выбор файла .enc
        ↓
POST /data/import
        ↓
┌─────────────────────────────────────────┐
│  1. Загрузка файла                      │
│  2. Проверка расширения (.enc)          │
│  3. Попытка дешифрования текущим ключом │
│  4. Валидация JSON структуры            │
│  5. Проверка обязательных полей         │
└─────────────────────────────────────────┘
        ↓
    Успех: Данные загружены
    Ошибка: "Неверный ключ" или "Поврежденный файл"
```

**Вариант 2: Импорт с внешним ключом**
```
Настройки → "Импорт с ключом"
        ↓
Выбор файла .enc + ввод ключа
        ↓
POST /data/import_external
        ↓
┌─────────────────────────────────────────┐
│  1. Загрузка файла                      │
│  2. Валидация ключа (Fernet формат)     │
│  3. Дешифрование указанным ключом       │
│  4. Валидация данных                    │
│  5. Слияние с существующими (опция)     │
│  6. Перешифрование текущим ключом       │
│  7. Сохранение                          │
└─────────────────────────────────────────┘
        ↓
    Успех: Данные импортированы
```

---

## 🔧 6. Настройки и конфигурация

### 6.1 Настройка YubiKey

```
Настройки → "Настройки YubiKey"
        ↓
┌─────────────────────────────────────────┐
│  Управление YubiKey                     │
├─────────────────────────────────────────┤
│  • Добавить новый ключ                  │
│  • Список существующих ключей           │
│  • Удалить ключ                         │
│  • Ограничить Public ID                 │
└─────────────────────────────────────────┘
```

**Добавление ключа:**
```
Форма добавления:
├─ Client ID (5-10 цифр)
├─ Secret Key (base64, ~20-30 символов)
├─ Имя ключа (для идентификации)
└─ Список Public ID (опционально)
        ↓
POST /yubikey/setup
        ↓
Сохранение в yubikey_config.json:
{
  "keys": [
    {
      "client_id": "12345",
      "secret_key": "abcd1234==",
      "name": "Мой YubiKey",
      "created_at": "2025-11-06T...",
      "public_ids": ["ccccccbtclie"]
    }
  ],
  "enabled": true
}
```

**Удаление ключа:**
```
Список ключей → Кнопка "Удалить"
        ↓
POST /yubikey/remove_key/<key_index>
        ↓
Удаление из массива keys[]
        ↓
Сохранение config
```

### 6.2 Смена Secret PIN

```
Настройки → "Сменить PIN"
        ↓
┌─────────────────────────────────────────┐
│  Форма смены PIN                        │
├─────────────────────────────────────────┤
│  • Текущий PIN                          │
│  • Новый PIN                            │
│  • Подтверждение нового PIN             │
└─────────────────────────────────────────┘
        ↓
POST /secret_login (action=change_pin)
        ↓
┌─────────────────────────────────────────┐
│  1. Проверка текущего PIN               │
│  2. Валидация нового PIN                │
│  3. Обновление в config.json:           │
│     security.secret_pin.current_pin     │
│  4. Запись лога изменения               │
└─────────────────────────────────────────┘
```

---

## 📈 7. Автоматические процессы

### 7.1 Проверка статуса подписок

При каждой загрузке списка сервисов (`load_ai_services()`):

```python
Для каждого сервиса:
    ↓
Есть next_payment_date?
    ↓ Да
Сравнение с текущей датой
    ↓
┌──────────────────────────────────┐
│ Дата прошла и auto_renewal=false │
│ → status = "expired"             │
├──────────────────────────────────┤
│ Дата в пределах 7 дней           │
│ → days_until_payment = X         │
│ → warning_badge = True           │
├──────────────────────────────────┤
│ Дата прошла больше 30 дней       │
│ → status = "suspended"           │
└──────────────────────────────────┘
```

### 7.2 Форматирование дат

```python
# ISO 8601 → Человеко-читаемый формат
"2025-12-06" → "6 декабря 2025"
"2025-11-30" → "30 ноября 2025"

# Относительные даты
next_payment_date - today:
├─ 0-1 дней → "Завтра"
├─ 2-7 дней → "Через X дней"
├─ 8-30 дней → "Через X дней"
└─ 30+ дней → "Дата"
```

### 7.3 Анализ хостинга (geolocation)

```python
Для сервисов с hosting_info.ip:
    ↓
GET https://ipinfo.io/{ip}/json
    ↓
Ответ:
{
  "ip": "203.0.113.42",
  "city": "Moscow",
  "region": "Moscow",
  "country": "RU",
  "org": "AS12345 Example Hosting"
}
    ↓
Сохранение в service:
├─ hosting_analysis.location = "Moscow, RU"
├─ hosting_analysis.provider = "Example Hosting"
└─ hosting_analysis.last_check = timestamp
```

---

## 🚨 8. Безопасность и логирование

### 8.1 Безопасность сессий

```python
# Flask session с уникальным именем cookie
SESSION_COOKIE_NAME = 'allmanagerc_session'

# Таймаут сессии: по закрытию браузера
PERMANENT_SESSION_LIFETIME = timedelta(hours=24)

# CSRF защита
SECRET_KEY = os.getenv('SECRET_KEY')
```

### 8.2 Защита от брутфорса

**Secret PIN:**
```python
Попытки входа отслеживаются в памяти:
├─ secret_login_attempts: int
├─ secret_login_blocked_until: timestamp
└─ secret_login_block_duration: 30 секунд

Логика:
if attempts >= 3:
    block_until = now + 30 секунд
    → Показ: "Подождите 30 секунд"
```

### 8.3 IP белый список

```python
# Разрешенные IP (по умолчанию: локальные)
ALLOWED_IPS = ['127.0.0.1', 'localhost', '::1']

@app.before_request
def check_ip_access():
    if request.remote_addr not in ALLOWED_IPS:
        abort(403)  # Forbidden
```

### 8.4 Логирование событий

```python
Логируются следующие события:
├─ Успешный вход (YubiKey OTP / PIN)
├─ Неудачная попытка входа
├─ Добавление/редактирование/удаление сервиса
├─ Смена ключа шифрования
├─ Импорт/экспорт данных
├─ Изменение настроек YubiKey
└─ Ошибки дешифрования
```

Формат лога:
```
[2025-11-06 14:30:00] INFO: User logged in with YubiKey OTP
[2025-11-06 14:32:15] INFO: Service added: OpenAI ChatGPT (ID: 5)
[2025-11-06 14:35:00] WARNING: Failed login attempt (invalid PIN)
```

---

## 🔄 9. Типичные сценарии использования

### Сценарий 1: Первый запуск

```
1. Установка приложения
2. Запуск: python run_app.py
3. Автоматическая генерация SECRET_KEY
4. Создание директорий data/ и uploads/
5. Редирект на /yubikey/setup
6. Настройка YubiKey (или использование PIN)
7. Вход в систему
8. Добавление первого AI сервиса
```

### Сценарий 2: Ежедневная работа

```
1. Запуск приложения
2. Вход через YubiKey OTP
3. Просмотр dashboard с сервисами
4. Проверка предупреждений о платежах
5. Копирование паролей (клик → clipboard)
6. Добавление нового сервиса
7. Выход (автоматический по закрытию окна)
```

### Сценарий 3: Резервное копирование

```
1. Настройки → "Экспорт всего"
2. Скачивание ZIP архива
3. Сохранение на внешний диск
4. (Опционально) Облачное хранилище
```

### Сценарий 4: Миграция на новый компьютер

```
На старом компьютере:
1. Экспорт полного пакета (.zip)

На новом компьютере:
1. Установка приложения
2. Настройки → "Импорт с ключом"
3. Загрузка data.enc + ключ из key.env
4. Импорт успешен → все данные восстановлены
```

### Сценарий 5: Потеря YubiKey

```
1. Вход через Secret PIN (резервный метод)
2. Настройки → YubiKey → Удалить потерянный ключ
3. Добавление нового YubiKey
4. Обновление списка разрешенных Public ID
```

---

## 📊 10. Архитектура компонентов

```
┌─────────────────────────────────────────────────────────┐
│                    PyWebView Window                     │
│                  (GUI Desktop App)                      │
└───────────────────────┬─────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│              Flask Application (app.py)                 │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   Routes    │  │ Auth Layers  │  │   Security   │  │
│  ├─────────────┤  ├──────────────┤  ├──────────────┤  │
│  │ /           │  │ IP Check     │  │ CSRF Token   │  │
│  │ /add        │  │ Session      │  │ Headers      │  │
│  │ /edit       │  │ YubiKey OTP  │  │ Rate Limit   │  │
│  │ /delete     │  │ Static Pass  │  │ Input Valid. │  │
│  │ /settings   │  │ Secret PIN   │  │              │  │
│  │ /data/*     │  └──────────────┘  └──────────────┘  │
│  │ /yubikey/*  │                                       │
│  └─────────────┘                                       │
└───────────────────────┬─────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│              Business Logic Layer                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────────┐     ┌─────────────────────────┐  │
│  │ Service Manager  │     │  Encryption Manager     │  │
│  ├──────────────────┤     ├─────────────────────────┤  │
│  │ • load_services  │     │ • encrypt_data()        │  │
│  │ • save_services  │     │ • decrypt_data()        │  │
│  │ • add_service    │     │ • change_key()          │  │
│  │ • edit_service   │     │ • Fernet wrapper        │  │
│  │ • delete_service │     └─────────────────────────┘  │
│  └──────────────────┘                                   │
│                                                         │
│  ┌──────────────────┐     ┌─────────────────────────┐  │
│  │ YubiKey Auth     │     │  Data Import/Export     │  │
│  │ (yubikey_auth.py)│     ├─────────────────────────┤  │
│  ├──────────────────┤     │ • export_data()         │  │
│  │ • verify_otp()   │     │ • export_package()      │  │
│  │ • check_online() │     │ • import_data()         │  │
│  │ • add_key()      │     │ • import_external()     │  │
│  │ • remove_key()   │     └─────────────────────────┘  │
│  └──────────────────┘                                   │
└───────────────────────┬─────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                  Data Layer                             │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Encrypted Storage (.enc files)                  │  │
│  ├──────────────────────────────────────────────────┤  │
│  │  • ai_services_YYYYMMDD_HHMMSS.enc               │  │
│  │  • backup_before_key_change_*.enc                │  │
│  │  • ai_services_reencrypted_*.enc                 │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Configuration Files (JSON)                      │  │
│  ├──────────────────────────────────────────────────┤  │
│  │  • config.json (app settings)                    │  │
│  │  • yubikey_config.json (keys + settings)         │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Environment & Keys (.env)                       │  │
│  ├──────────────────────────────────────────────────┤  │
│  │  • SECRET_KEY (Fernet encryption key)            │  │
│  │  • YUBIKEY_STATIC_PASSWORDS                      │  │
│  │  • DEV_PIN                                       │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │  User Uploads (files)                            │  │
│  ├──────────────────────────────────────────────────┤  │
│  │  • uploads/ (service icons)                      │  │
│  │  • receipts/ (payment receipts per service)      │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## 🎓 11. Ключевые принципы работы

### Принцип 1: Шифрование в покое (Encryption at Rest)
Все чувствительные данные **шифруются перед сохранением** на диск. Даже если кто-то получит доступ к файлам, они увидят только зашифрованные данные.

### Принцип 2: Дешифрование в памяти (In-Memory Decryption)
Данные **дешифруются только в оперативной памяти** при загрузке. После завершения работы все остается зашифрованным.

### Принцип 3: Многофакторная аутентификация
Система поддерживает **три независимых метода входа**:
- YubiKey OTP (аппаратный ключ)
- Статические пароли (офлайн)
- Secret PIN (резервный доступ)

### Принцип 4: Изоляция компонентов
Каждый модуль отвечает за свою задачу:
- `app.py` - веб-интерфейс и маршрутизация
- `yubikey_auth.py` - аутентификация
- `security_logger.py` - логирование
- Fernet - криптография

### Принцип 5: Резервное копирование
При критических операциях (смена ключа) **автоматически создаются резервные копии** с возможностью отката.

---

## 🔍 12. Решение типичных проблем

### Проблема: "Invalid token" при загрузке данных

**Причина:** SECRET_KEY не совпадает с ключом, которым были зашифрованы данные.

**Решение:**
1. Проверьте .env файл
2. Используйте импорт с внешним ключом
3. Восстановите из резервной копии

### Проблема: YubiKey не работает (офлайн)

**Причина:** Нет интернет-соединения для проверки OTP.

**Решение:**
1. Используйте статический пароль
2. Или Secret PIN
3. Настройте YUBIKEY_STATIC_PASSWORDS в .env

### Проблема: Забыт Secret PIN

**Причина:** PIN хранится в config.json или переменных окружения.

**Решение:**
1. Проверьте config.json → security.secret_pin.current_pin
2. Или установите DEV_PIN в .env
3. По умолчанию: "1234"

### Проблема: Данные не сохраняются

**Причина:** Нет прав записи в директорию данных.

**Решение:**
1. Проверьте права на папку:
   - Windows: %APPDATA%\AllManagerC\
   - macOS: ~/Library/Application Support/AllManagerC/
2. Запустите от имени администратора (Windows)
3. Проверьте логи приложения

---

## 📚 Заключение

AI Manager - это комплексное решение для безопасного управления учетными данными AI сервисов, сочетающее:

- ✅ **Надежное шифрование** (Fernet AES-128)
- ✅ **Многофакторную аутентификацию** (YubiKey + PIN)
- ✅ **Удобный интерфейс** (GUI + Web)
- ✅ **Резервное копирование** (автоматическое и ручное)
- ✅ **Кросс-платформенность** (Windows/macOS/Linux)

Приложение следует принципам **Security by Design**, обеспечивая защиту данных на всех уровнях архитектуры.

---

## 📖 Дополнительная документация

- [README.md](README.md) - Общая информация и установка
- [АУТЕНТИФИКАЦИЯ.md](АУТЕНТИФИКАЦИЯ.md) - Подробная настройка YubiKey
- [BUILD_MACOS.md](BUILD_MACOS.md) - Сборка для macOS
- [CROSS_PLATFORM_GUIDE.md](CROSS_PLATFORM_GUIDE.md) - Кросс-платформенная разработка

---

**Версия документа:** 1.0
**Дата:** 6 ноября 2025
**Версия приложения:** 5.6.0
