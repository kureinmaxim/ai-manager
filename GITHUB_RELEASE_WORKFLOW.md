# Руководство: публикация изменений и выпуск релиза через GitHub CLI (gh)

Это краткая инструкция из двух частей:
- Теория — что происходит при публикации изменений и релиза.
- Практика — готовые команды, повторяющие наш реальный сценарий в этом проекте.

---

## 1) Теория (что делаем и зачем)

- **Git-репозиторий**: локальная история коммитов. Изменения фиксируются `git add` → `git commit`, затем публикуются в удалённый репозиторий `git push`.
- **Ветка**: основная ветка — `main`. Мы коммитим и пушим в неё изменения UI.
- **Теги**: пометки конкретной версии кода. Для релизов используют аннотированные теги `vX.Y.Z` (например, `v5.5.7`).
- **Релиз GitHub**: объект на GitHub, привязанный к тегу. Содержит заголовок, заметки (release notes) и, при желании, файлы-артефакты. Управляем через `gh`.
- **Источник версии**: в этом проекте номер версии хранится в `config.json` → `app_info.version`. Мы читаем его, формируем тег `v<version>` и используем для релиза.
- **Заметки релиза**: формируем из секции `[Неопубликовано]` файла `CHANGELOG.md`.

Итого поток работ:
1. Зафиксировать изменения (`git add` → `git commit`).
2. Опубликовать их (`git push`).
3. Прочитать версию → создать и отправить тег (`git tag` → `git push origin <tag>`).
4. Создать релиз `gh release create <tag>` с заметками.

---

## 2) Практика (готовые команды)

Команды рассчитаны на macOS и встроенный терминал Cursor (добавляем `| cat` там, где возможен пейджер/длинный вывод; используем `python3`). Выполняйте их из корня проекта.

### Проверка окружения
```bash
# Версия GitHub CLI
gh --version | cat

# Авторизация gh (должно показать Logged in)
gh auth status | cat

# Текущее состояние репозитория
git status | cat
```

### Коммит и пуш изменений
```bash
# Зафиксировать изменённые файлы (пример)
git add CHANGELOG.md templates/layout.html templates/yubikey_login.html

# Коммит с сообщением
git commit -m "UI: доступ к настройке YubiKey при 0 ключей; кнопка перехода со страницы входа; обновлен CHANGELOG"

# Публикация в origin/main
git push origin main | cat
```

### Тег версии из config.json
```bash
# Считать версию из config.json (app_info.version)
VERSION=$(python3 - <<'PY'
import json
print(json.load(open('config.json'))['app_info']['version'])
PY
)
TAG="v${VERSION}"
echo "Готовим тег: $TAG" | cat

# Создать аннотированный тег и отправить его
git tag -a "$TAG" -m "Release $TAG: UI improvements for YubiKey setup access"
git push origin "$TAG" | cat
```

### Заметки релиза из CHANGELOG и публикация
```bash
# Вытянуть текст из секции [Неопубликовано] CHANGELOG.md
REL_NOTES=$(awk '/^## \[Неопубликовано\]/{flag=1;next}/^## \[/{flag=0}flag' CHANGELOG.md | sed 's/^#\{1,\}//')

# Создать релиз на GitHub, привязанный к тегу
gh release create "$TAG" \
  --title "AllManagerC $TAG" \
  --notes "$REL_NOTES" | cat
```

### Полезные команды после релиза
```bash
# Просмотреть релиз
gh release view "$TAG" | cat

# Открыть релиз в браузере
gh release view "$TAG" --web

# Загрузить артефакты (пример: dmg или zip)
# gh release upload "$TAG" dist/AllManagerC_Installer.dmg --clobber | cat
```

### Откат (при необходимости)
```bash
# Удалить релиз (тег останется)
gh release delete "$TAG" --yes | cat

# Удалить локальный и удалённый тег
git tag -d "$TAG"
git push origin :refs/tags/"$TAG" | cat
```

---

## Рекомендации
- Если включены правила ветки (подписанные коммиты и т.п.), настройте подпись (`git commit -S`) и GPG/SSH.
- Держите `CHANGELOG.md` актуальным: переносите записи из `[Неопубликовано]` в новую секцию версии после релиза.
- Для автоматизации удобно создать `scripts/release.sh` или цель `make release`.

Готово: следуя шагам выше, вы воспроизведёте процесс релиза `v5.5.7`, использованный в этом проекте.
